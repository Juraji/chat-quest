<form [formGroup]="editMessageFormGroup" (submit)="onEditMessageSubmit()">
  <div class="card bg-secondary"
       [class.me-5]="!isUser()"
       [class.ms-5]="isUser()">
    @if (editMessage()) {
      <textarea class="form-control rounded-top-0" formControlName="content" rows="10"></textarea>
    } @else {
      <div class="card-body">
        @if (reasoning(); as s) {
          @if (showReasoning()) {
            <div class="thought-block open mb-3 position-relative">
              <button type="button" class="btn btn-sm position-absolute end-0" (click)="showReasoning.toggle()">
                <span class="bi bi-x"></span>
              </button>
              <span>{{ s }}</span>
            </div>
          } @else {
            <div class="thought-block mb-3 text-muted small cursor-pointer"
                 (click)="showReasoning.toggle()">
              @if (isGenerating()) {
                <span>Thinking...</span>
              } @else {
                <span>Thoughts</span>
              }
              <i class="ms-2 small">(Click to view)</i>
            </div>
          }
        }
        <app-rendered-message [message]="content()" [renderOptions]="{enableVariables: false}"/>
      </div>
    }
    <div class="card-footer d-flex align-items-center gap-2">
      @if (characterAvatar(); as url) {
        <img class="character-avatar" [src]="url" alt="Character avatar"/>
      }
      <h6 class="mb-0" [class.flex-grow-1]="!isGenerating()">{{ characterName() }}</h6>
      @if (isGenerating()) {
        <div class="dots-of-generation ms-2 flex-grow-1">
          <div class="dot dot-1"></div>
          <div class="dot dot-2"></div>
          <div class="dot dot-3"></div>
        </div>
      }
      <div class="btn-toolbar gap-1 message-actions">
        @if (editMessage()) {
          <button type="button" class="btn btn-sm btn-outline-danger"
                  (click)="editMessage.toggle()">
            <span class="bi bi-x"></span>
          </button>
          <button class="btn btn-sm btn-primary">
            <span class="bi bi-save"></span>
          </button>
        } @else {
          @if (isGenerating()) {
            <button type="button" class="btn btn-sm btn-danger"
                    (click)="onCancelGeneration()"
                    title="Cancel the current generation">
              <span class="bi bi-stop"></span>
            </button>
          } @else {
            <button type="button" class="btn btn-sm btn-secondary"
                    title="Toggle archival state for this message"
                    (click)="onToggleArchived()">
              <span class="bi"
                    [class.bi-archive]="!isArchived()"
                    [class.bi-folder2-open]="isArchived()"></span>
            </button>
            @if (!isUser()) {
              <button type="button" class="btn btn-sm btn-secondary"
                      title="Regenerate this message"
                      (click)="onRegenerateMessage()">
                <span class="bi bi-arrow-repeat"></span>
              </button>
            }
            <div dropdown>
              <ul class="mt-1 message-dropdown" dropdownMenu>
                <li><h5 class="dropdown-header">Generate memory for this message</h5></li>
                <li>
                  <button type="button" class="dropdown-item" (click)="onGenerateMemory(null)">
                    <span>Just this message</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dropdown-item" (click)="onGenerateMemory(1)">
                    <span>Include previous message</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dropdown-item" (click)="onGenerateMemory(2)">
                    <span>Include previous 2 messages</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dropdown-item" (click)="onGenerateMemory(5)">
                    <span>Include previous 5 messages</span>
                  </button>
                </li>
                <li>
                  <button type="button" class="dropdown-item" (click)="onGenerateMemory(10)">
                    <span>Include previous 10 messages</span>
                  </button>
                </li>
              </ul>
              <button type="button" class="btn btn-sm btn-secondary"
                      title="Generate a memory from this message"
                      dropdownToggle>
                <span class="bi bi-bookmark-heart"></span>
              </button>
            </div>
            <button type="button" class="btn btn-sm btn-secondary"
                    title="Branch into a new chat"
                    (click)="onForkChat()">
              <span class="bi bi-alt"></span>
            </button>
            <button type="button" class="btn btn-sm btn-secondary"
                    (click)="editMessage.toggle()"
                    title="Edit this message">
              <span class="bi bi-pencil"></span>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger"
                    (click)="onDeleteMessage()"
                    title="Delete this message (and all messages after this)">
              <span class="bi bi-trash"></span>
            </button>
          }
        }
      </div>
    </div>
  </div>
</form>
