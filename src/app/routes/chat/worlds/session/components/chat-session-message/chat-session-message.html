<form [formGroup]="editMessageFormGroup" (submit)="onEditMessageSubmit()">
  <div class="card bg-secondary"
       [class.me-5]="!isUser()"
       [class.ms-5]="isUser()">
    <div class="card-header d-flex align-items-center gap-2">
      @if (characterAvatar(); as url) {
        <img class="character-avatar" [src]="url" alt="Character avatar"/>
      }
      <h6 class="mb-0" [class.flex-grow-1]="!isGenerating()">{{ characterName() }}</h6>
      @if (isGenerating()) {
        <div class="dots-of-generation ms-2 flex-grow-1">
          <div class="dot dot-1"></div>
          <div class="dot dot-2"></div>
          <div class="dot dot-3"></div>
        </div>
      }
      <div class="btn-toolbar gap-1 message-actions">
        @if (editMessage()) {
          <button type="button" class="btn btn-sm btn-outline-danger"
                  (click)="editMessage.toggle()">
            <span class="bi bi-x"></span>
          </button>
          <button class="btn btn-sm btn-primary">
            <span class="bi bi-save"></span>
          </button>
        } @else if (!isGenerating()) {
          @if (isArchived()) {
            <span class="bi bi-archive p-1"
                  title="This message is archived and will not be used in the context"></span>
          }
          @if (!isUser()) {
            <button type="button" class="btn btn-sm btn-secondary"
                    title="Regenerate this message"
                    (click)="onRegenerateMessage()">
              <span class="bi bi-arrow-repeat"></span>
            </button>
          }
          <button type="button" class="btn btn-sm btn-secondary"
                  title="Generate a memory from this message"
                  (click)="onGenerateMemory()">
            <span class="bi bi-bookmark-heart"></span>
          </button>
          <button type="button" class="btn btn-sm btn-secondary"
                  title="Branch into a new chat"
                  (click)="onForkChat()">
            <span class="bi bi-box-arrow-up-right"></span>
          </button>
          <button type="button" class="btn btn-sm btn-secondary"
                  (click)="editMessage.toggle()"
                  title="Edit this message">
            <span class="bi bi-pencil"></span>
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger"
                  (click)="onDeleteMessage()"
                  title="Delete this message (and all messages after this)">
            <span class="bi bi-trash"></span>
          </button>
        }
      </div>
    </div>
    @if (editMessage()) {
      <textarea class="form-control rounded-top-0" formControlName="content" rows="10"></textarea>
    } @else {
      <div class="card-body">
        <app-rendered-message [message]="content()" [renderOptions]="{enableVariables: false}"/>
      </div>
    }
  </div>
</form>
